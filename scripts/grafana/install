#!/usr/bin/env bash

set -e

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Install Grafana dependencies
sudo apt-get install libfontconfig1 fontconfig-config fonts-dejavu-core ttf-bitstream-vera fonts-liberation sqlite3 -y

# Download and install unofficial build of Grafana for ARM
URL="https://bintray.com/fg2it/deb/download_file?file_path=main%2Fg%2Fgrafana_4.3.2_armhf.deb"
if $(uname -m | grep -Eq ^armv6); then
    URL="https://bintray.com/fg2it/deb-rpi-1b/download_file?file_path=main%2Fg%2Fgrafana_4.3.2_armhf.deb"
fi
mkdir "$BASE_DIR/tmp"
wget ${URL} -O "$BASE_DIR/tmp/go-grafana.tar.gz"
sudo dpkg -i "$BASE_DIR/tmp/go-grafana.tar.gz"
rm -rf "$BASE_DIR/tmp"

# Configure systemd to start grafana-server.service on system boot
sudo systemctl daemon-reload
sudo systemctl enable grafana-server.service
sudo systemctl start grafana-server.service

# Wait for server to start
sleep 30

# Add data source and dashboard
curl --user admin:admin -X POST -H 'Content-Type: application/json' --data-binary '{"name":"prometheus","type":"prometheus","url":"http://localhost:9090","access":"proxy","isDefault":true}' http://localhost:3000/api/datasources
curl --user admin:admin -X POST -H 'Content-Type: application/json' --data-binary '{"dashboard":{"id":null,"title":"Mesh Node Metrics","tags":["prometheus"],"timezone":"browser","rows":[{"collapse":false,"height":250,"panels":[{"aliasColors":{},"bars":true,"dashLength":10,"dashes":false,"datasource":"prometheus","decimals":2,"fill":1,"id":81,"legend":{"alignAsTable":true,"avg":true,"current":false,"max":true,"min":true,"show":true,"total":false,"values":true},"lines":true,"linewidth":1,"links":[],"minSpan":2,"nullPointMode":"null","percentage":false,"pointradius":5,"points":false,"renderer":"flot","repeat":"node","scopedVars":{"node":{"selected":true,"text":"localhost:9100","value":"localhost:9100"}},"seriesOverrides":[],"spaceLength":10,"span":12,"stack":true,"steppedLine":false,"targets":[{"expr":"sum(increase(node_network_receive_bytes{instance=~\"$node\",device=\"tun0\"}[5m]))","hide":false,"intervalFactor":1,"legendFormat":"Received","refId":"A","step":15},{"expr":"sum(increase(node_network_transmit_bytes{instance=~\"$node\",device=\"tun0\"}[5m]))","hide":false,"intervalFactor":1,"legendFormat":"Sent","refId":"B","step":15}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Total tun0 Utilization","tooltip":{"shared":true,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"bytes","label":null,"logBase":1,"max":null,"min":"0","show":true},{"format":"bytes","label":null,"logBase":1,"max":null,"min":"0","show":true}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"tun0 Total","titleSize":"h6"}],"schemaVersion":6,"version":0},"overwrite":false}' http://localhost:3000/api/dashboards/db