#!/usr/bin/env bash

set -e


BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if ! [ "$(which confget)" ]; then
   sudo apt-get install confget
fi

# Install hostapd and dnsmasq to run IEEE 802.11 Access Point
if ! [ "$(which hostapd)" ] || ! [ "$(which dnsmasq)" ] || ! [ "$(which iptables)" ]; then
    sudo apt-get install hostapd dnsmasq radvd iptables -y
fi

APSSID=$(sudo grep -m 1 '"ipv6"' /etc/cjdroute.conf | awk '{ print $2 }' | sed 's/[",]//g' | sed "s/.*:/$MESH_NAME-/g")
while [ "${#APPASS}" -lt 8 ] || [ "${#APPASS}" -gt 63 ]; do
   read -p "Set WPA2-PSK password (8-63 characters): " APPASS;
done

sudo cp $BASE_DIR/75-lan-bridge.neddev /etc/systemd/network/75-lan-bridge.neddev
sudo cp $BASE_DIR/75-lan-bridge.network /etc/systemd/network/75-lan-bridge.network

sudo cp $BASE_DIR/95-wlan-hostap.link /etc/systemd/network/95-wlan-hostap.link
sudo sed -i "s/##SSID##/$APSSID/g" "/etc/systemd/network/95-wlan-hostap.link"
sudo sed -i "s/##PSK##/$APPASS/g" "/etc/systemd/network/95-wlan-hostap.link"
sudo cp $BASE_DIR/95-wlan-hostap.network /etc/systemd/network/95-wlan-hostap.network
sudo cp $BASE_DIR/50-hostapd.rules /etc/udev/rules.d/50-hostapd.rules 

sudo cp $BASE_DIR/hostapd.template.conf /etc/hostapd/hostapd.template.conf

sudo cp $BASE_DIR/hostapd.template /usr/local/sbin/hostapd.template
sudo chmod 744 /usr/local/sbin/hostapd.template

sudo cp $BASE_DIR/hostapd\@.service /etc/systemd/system/hostapd\@.service  

sudo cp "$BASE_DIR/hostapd.nat" /usr/local/sbin/hostapd.nat
sudo chmod 744 /usr/local/sbin/hostapd.nat

sudo cp $BASE_DIR/radvd.conf "/etc/radvd.conf"
